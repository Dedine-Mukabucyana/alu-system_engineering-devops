#!/usr/bin/env bash
# Installs and configures HAProxy with roundrobin load balancing

sudo apt-get update -y
sudo apt-get install -y haproxy

# enable haproxy in /etc/default
sudo sed -i "s/ENABLED=0/ENABLED=1/" /etc/default/haproxy || true

# write haproxy configuration
sudo bash -c \"cat > /etc/haproxy/haproxy.cfg << HPCFG
global
    log /dev/log local0
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    server 6822-web-01 52.91.188.182:80 check
    server 6822-web-02 3.86.25.85:80 check
HPCFG\"

# restart haproxy
sudo service haproxy restart
